import{r as i,h as X,j as e,b as P,k as se,u as ae,a as ne}from"./index-Cfx8vNNh.js";import{M as re}from"./MarkdownRenderer-EnzfZmAz.js";import{u as le,A as V,c as ie}from"./AdminLayout-DBr5zY72.js";/* empty css                   */const oe=({value:h,onChange:k,disabled:d=!1,className:M="",placeholder:O="Upload Cover Image",maxSize:y=10,accept:n="image/*",supportPaste:g=!0,supportDragDrop:I=!0})=>{const[E,F]=i.useState(!1),[$,S]=i.useState(!1),[j,p]=i.useState(null),R=i.useRef(null),T=i.useRef(null),{showNotification:C}=X();i.useEffect(()=>{if(!g||d)return;const r=async u=>{if(!T.current?.contains(document.activeElement))return;const o=u.clipboardData;if(!o)return;const v=Array.from(o.files).filter(b=>b.type.startsWith("image/"));if(v.length>0){u.preventDefault(),await D(v[0]);return}const G=Array.from(o.items).filter(b=>b.type.startsWith("image/"));if(G.length>0){u.preventDefault();const b=G[0].getAsFile();b&&await D(b)}};return document.addEventListener("paste",r),()=>document.removeEventListener("paste",r)},[g,d]);const L=r=>{if(!["image/jpeg","image/jpg","image/png","image/webp","image/gif"].includes(r.type))return"Please select a valid image file (JPG, PNG, WebP, GIF)";const o=y*1024*1024;return r.size>o?`Image size must be less than ${y}MB`:null},D=async r=>{if(!r||d)return;const u=L(r);if(u){p(u),C({type:"error",title:"Invalid File",message:u});return}try{F(!0),p(null);const o=await P.uploadPostCover(r);if(o.success&&o.data?.file_url){const v=`${P.getImageUrl(o.data.file_url)}?t=${Date.now()}`;k?.(v),C({type:"success",title:"Cover Uploaded",message:"Cover image has been uploaded successfully"})}else throw new Error(o.error||"Failed to upload cover")}catch(o){const N=o instanceof Error?o.message:"Failed to upload cover image";p(N),C({type:"error",title:"Upload Failed",message:N})}finally{F(!1)}},A=i.useCallback(r=>{r.preventDefault(),!d&&I&&S(!0)},[d,I]),B=i.useCallback(r=>{r.preventDefault(),S(!1)},[]),_=i.useCallback(async r=>{if(r.preventDefault(),S(!1),!d&&I){const o=Array.from(r.dataTransfer.files).filter(N=>N.type.startsWith("image/"));if(o.length===0){C({type:"warning",title:"No Images Found",message:"Please drop image files only."});return}await D(o[0])}},[d,I]),W=async r=>{const u=r.target.files?.[0];u&&await D(u),r.target.value=""},w=()=>{d||R.current?.click()},z=()=>{k?.(null),p(null)};return e.jsxs("div",{className:`cover-upload ${M}`,ref:T,children:[e.jsx("input",{ref:R,type:"file",accept:n,onChange:W,style:{display:"none"},disabled:d}),h?e.jsxs("div",{className:"cover-preview",children:[e.jsx("img",{src:h,alt:"Cover preview",className:"cover-image"}),e.jsxs("div",{className:"cover-overlay",children:[e.jsx("md-icon-button",{onClick:w,title:"Change cover",children:e.jsx("md-icon",{children:"edit"})}),e.jsx("md-icon-button",{onClick:z,title:"Remove cover",children:e.jsx("md-icon",{children:"delete"})})]}),E&&e.jsxs("div",{className:"upload-progress-overlay",children:[e.jsx("md-circular-progress",{indeterminate:!0}),e.jsx("span",{children:"Uploading..."})]})]}):e.jsx("div",{className:`cover-upload-zone ${$?"drag-over":""} ${d?"disabled":""}`,onDragOver:A,onDragLeave:B,onDrop:_,onClick:w,tabIndex:0,onKeyDown:r=>r.key==="Enter"&&w(),children:E?e.jsxs("div",{className:"upload-progress-content",children:[e.jsx("md-circular-progress",{indeterminate:!0}),e.jsx("p",{className:"md-typescale-body-medium",children:"Uploading cover..."})]}):e.jsxs("div",{className:"upload-content",children:[e.jsx("md-icon",{class:"upload-icon",children:"cloud_upload"}),e.jsx("h3",{className:"md-typescale-title-medium",children:O}),e.jsxs("p",{className:"md-typescale-body-medium",children:[I?"Drag & drop, click to browse":"Click to select",g?", or paste from clipboard":""]}),e.jsxs("p",{className:"md-typescale-body-small",children:["Images only • Max ",y,"MB • Supports JPG, PNG, WebP, GIF"]})]})}),j&&e.jsxs("div",{className:"upload-error",children:[e.jsx("md-icon",{children:"error"}),e.jsx("span",{children:j})]})]})},ge=()=>{const{id:h}=se(),k=ae(),{showNotification:d}=X(),{categories:M,tags:O}=ne(),y=h!=="new",[n,g]=i.useState({title:"",excerpt:"",content:"",category:"",tags:[],featured:!1,status:"draft",coverUrl:"",images:[]}),[I,E]=i.useState(!1),[F,$]=i.useState(!1),[S,j]=i.useState(null),[p,R]=i.useState(!1),[T,C]=i.useState(!1),L=i.useRef(null),[D,A]=i.useState(!1),B=i.useRef(null),_=t=>{g(s=>({...s,coverUrl:t||""}))},W=t=>{const s=/!\[.*?\]\((.*?)\)/g,a=[];let l;for(;(l=s.exec(t))!==null;){const c=l[1];c&&!a.includes(c)&&a.push(c)}return a},w=t=>{const s=`![Image](${t})`,a=document.querySelector('md-outlined-text-field[label="Content (Markdown)"]');let l=null;if(a&&(l=a.querySelector("textarea")||a.shadowRoot?.querySelector("textarea")||a.renderRoot?.querySelector("textarea")),l){const c=l.selectionStart||0,x=n.content,m=x.slice(0,c)+s+x.slice(c);g(f=>({...f,content:m,images:[...f.images,t].filter((U,J,te)=>te.indexOf(U)===J)})),setTimeout(()=>{l.focus(),l.setSelectionRange(c+s.length,c+s.length)},0)}else{const c=n.content,x=c&&!c.endsWith(`
`)?`

`:`
`;g(m=>({...m,content:m.content+x+s,images:[...m.images,t].filter((f,U,J)=>J.indexOf(f)===U)})),d({type:"info",title:"Image Inserted",message:"Image has been added to the end of your content."})}};i.useEffect(()=>{y&&h&&z(h)},[y,h]);const z=async t=>{try{E(!0),j(null);const s=await P.getPost(t);if(s.success&&s.data){const a=s.data;let l="";const c=M.find(m=>m.name===a.category);c&&(l=c.id);const x=W(a.content||"");g({title:a.title,excerpt:a.excerpt,content:a.content||"",category:l,tags:a.tags,featured:a.featured||!1,status:a.status==="published"?"published":"draft",coverUrl:a.coverImage||a.imageUrl||"",images:x})}else j(s.error||"Failed to load post")}catch(s){j(s instanceof Error?s.message:"Failed to load post")}finally{E(!1)}},r=(t,s)=>{g(a=>({...a,[t]:s}))},u=t=>{t&&!n.tags.includes(t)&&g(s=>({...s,tags:[...s.tags,t]}))},o=t=>{u(t)},N=t=>{g(s=>({...s,tags:s.tags.filter(a=>a!==t)}))},v=async t=>{if(!t)return null;try{C(!0);const s=await P.uploadPostImage(t);if(s.success&&s.data?.file_url)return d({type:"success",title:"Image Uploaded",message:"Image has been uploaded successfully"}),P.getImageUrl(s.data.file_url);throw new Error(s.error||"Failed to upload image")}catch(s){return console.error("Image upload failed:",s),d({type:"error",title:"Upload Failed",message:s instanceof Error?s.message:"Failed to upload image"}),null}finally{C(!1)}},K=t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.types.includes("Files")&&A(!0)},G=t=>{t.preventDefault(),t.stopPropagation(),A(!1)},b=async t=>{t.preventDefault(),t.stopPropagation(),A(!1);const a=Array.from(t.dataTransfer.files).filter(l=>l.type.startsWith("image/"));if(a.length===0){d({type:"warning",title:"No Images Found",message:"Please drop image files only."});return}for(const l of a){const c=await v(l);c&&w(c)}},Y=async t=>{const s=t.clipboardData,l=Array.from(s.files).filter(m=>m.type.startsWith("image/"));if(l.length>0){t.preventDefault();for(const m of l){const f=await v(m);f&&w(f)}return}const x=Array.from(s.items).filter(m=>m.type.startsWith("image/"));if(x.length>0){t.preventDefault();for(const m of x){const f=m.getAsFile();if(f){const U=await v(f);U&&w(U)}}}},q=async t=>{try{$(!0),j(null);const s=W(n.content),a={title:n.title.trim()||"Untitled",excerpt:n.excerpt.trim()||(n.content.trim()?n.content.substring(0,150)+"...":"No excerpt"),content:n.content.trim()||"",category:n.category,tags:n.tags,featured:n.featured,status:t,coverImage:n.coverUrl,author:"Admin",publishDate:t==="published"?new Date().toISOString():void 0,readTime:Math.ceil((n.content||"").split(" ").length/200),images:s};let l;if(y&&h?l=await P.updatePost(h,a):l=await P.createPost(a),l.success)d({type:"success",title:t==="published"?"Post Published!":"Draft Saved!",message:`"${n.title}" has been ${t==="published"?"published":"saved as draft"} successfully.`}),k("/admin/posts");else throw new Error(l.error||"Failed to save post")}catch(s){j(s instanceof Error?s.message:"Failed to save post")}finally{$(!1)}},H=()=>{confirm("Are you sure you want to discard your changes?")&&k("/admin/posts")},Z=ie({save:()=>q("draft"),publish:()=>q("published"),cancel:H,preview:()=>R(!p)});le(Z,{enabled:!F});const Q=y?"Edit Post":"New Post",ee=e.jsxs("div",{className:"editor-actions",children:[e.jsx("md-text-button",{onClick:H,children:"Cancel"}),e.jsx("md-outlined-button",{onClick:()=>q("draft"),children:F?e.jsxs(e.Fragment,{children:[e.jsx("md-circular-progress",{indeterminate:!0,slot:"icon",style:{width:"18px",height:"18px"}}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx("md-icon",{slot:"icon",children:"save"}),"Save Draft"]})}),e.jsx("md-filled-button",{onClick:()=>q("published"),children:F?e.jsxs(e.Fragment,{children:[e.jsx("md-circular-progress",{indeterminate:!0,slot:"icon",style:{width:"18px",height:"18px"}}),"Publishing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("md-icon",{slot:"icon",children:"publish"}),"Publish"]})})]});return I?e.jsx(V,{title:Q,children:e.jsxs("div",{className:"post-editor-loading",children:[e.jsx("md-circular-progress",{indeterminate:!0}),e.jsx("p",{className:"md-typescale-body-medium",children:"Loading post..."})]})}):e.jsx(V,{title:Q,actions:ee,children:e.jsxs("div",{className:"post-editor",children:[S&&e.jsxs("div",{className:"post-editor-error",children:[e.jsx("md-icon",{children:"error"}),e.jsx("span",{children:S})]}),e.jsxs("div",{className:"post-editor-form",children:[e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"md-typescale-headline-small",children:"Basic Information"}),e.jsx("md-outlined-text-field",{label:"Post Title",value:n.title,onInput:t=>r("title",t.target.value),required:!0,class:"title-field"}),e.jsx("md-outlined-text-field",{label:"Excerpt",value:n.excerpt,onInput:t=>r("excerpt",t.target.value),type:"textarea",rows:3,class:"excerpt-field"}),e.jsxs("div",{className:"cover-upload-section",children:[e.jsx("label",{className:"md-typescale-body-large",children:"Cover Image"}),e.jsx(oe,{value:n.coverUrl,onChange:_,placeholder:"Upload Cover Image",maxSize:10,supportPaste:!0,supportDragDrop:!0})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"content-header",children:[e.jsxs("div",{className:"content-title-section",children:[e.jsx("h2",{className:"md-typescale-headline-small",children:"Content"}),e.jsx("p",{className:"md-typescale-body-small content-hint",children:"Supports Markdown • Drag & drop images • Paste images from clipboard"})]}),e.jsxs("div",{className:"content-actions",children:[e.jsxs("md-outlined-button",{onClick:()=>L.current?.click(),children:[e.jsx("md-icon",{slot:"icon",children:"image"}),T?"Uploading...":"Insert Image"]}),e.jsx("input",{ref:L,type:"file",accept:"image/*",onChange:async t=>{const s=t.target.files?.[0];if(s){const a=await v(s);a&&w(a)}t.target.value=""},style:{display:"none"},disabled:T}),e.jsxs("md-outlined-button",{onClick:()=>R(!p),class:p?"active":"",children:[e.jsx("md-icon",{slot:"icon",children:p?"edit":"preview"}),p?"Edit":"Preview"]})]})]}),p?e.jsx("div",{className:"content-preview",children:e.jsx(re,{content:n.content||"No content to preview",className:"markdown-preview"})}):e.jsxs("div",{className:`content-editor-wrapper ${D?"drag-over":""}`,onDragOver:K,onDragLeave:G,onDrop:b,children:[e.jsx("md-outlined-text-field",{label:"Content (Markdown)",value:n.content,onInput:t=>r("content",t.target.value),onPaste:Y,type:"textarea",rows:20,class:"content-field",ref:B}),D&&e.jsx("div",{className:"drag-overlay",children:e.jsxs("div",{className:"drag-overlay-content",children:[e.jsx("md-icon",{class:"drag-icon",children:"image"}),e.jsx("p",{className:"md-typescale-body-large",children:"Drop images here to upload"}),e.jsx("p",{className:"md-typescale-body-medium",children:"Images will be uploaded and inserted as markdown"})]})})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h2",{className:"md-typescale-headline-small",children:"Metadata"}),e.jsxs("div",{className:"metadata-grid",children:[e.jsxs("md-outlined-select",{label:"Category",value:n.category,onInput:t=>r("category",t.target.value),children:[e.jsx("md-select-option",{value:"",children:"Select Category"}),M.map(t=>e.jsx("md-select-option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"featured-toggle",children:[e.jsx("md-switch",{selected:n.featured,onChange:t=>r("featured",t.target.selected)}),e.jsx("span",{className:"md-typescale-body-medium",children:"Featured Post"})]})]}),e.jsx("div",{className:"tags-section",children:e.jsxs("div",{className:"tags-input-container",children:[n.tags.length>0&&e.jsx("div",{className:"current-tags",children:e.jsx("div",{className:"tags-list",children:n.tags.map((t,s)=>e.jsxs("div",{className:"current-tag-wrapper",children:[e.jsx("md-assist-chip",{className:"tag-chip current-tag-chip",children:t}),e.jsx("button",{className:"remove-tag-btn",onClick:()=>N(t),title:`Remove ${t} tag`,children:"×"})]},s))})}),O.length>0&&e.jsxs("div",{className:"popular-tags",children:[e.jsx("div",{className:"suggestions-header",children:"Popular tags:"}),e.jsx("div",{className:"suggestions-list",children:O.filter(t=>!n.tags.includes(t.name)).slice(0,8).map(t=>e.jsxs("md-assist-chip",{className:"available-chip",onClick:()=>o(t.name),children:[e.jsx("md-icon",{slot:"icon",children:"add"}),t.name]},t.id))})]})]})})]})]})]})})};export{ge as default};
